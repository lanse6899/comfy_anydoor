# AnyDoor - ComfyUI 节点控制与惰性值机制插件

AnyDoor 是一个功能强大的 ComfyUI 插件，提供节点 Bypass 控制和惰性值机制分支功能。

PS：商用平台方使用请知会一声哈！

使用说明视频：
https://www.bilibili.com/video/BV11k1wBhErF/

## 功能特性

### 节点控制功能
- ✅ 根据节点编号控制节点的 bypass 状态
- ✅ 支持输入任意节点编号（1-999999）
- ✅ 实时控制：修改节点编号或模式时立即生效
- ✅ 三种模式：正常执行、禁用、忽略
- ✅ 文本匹配控制：根据文本索引匹配控制节点
- ✅ 五键切换控制：快速切换多组节点状态

### 惰性值机制功能
- ✅ 惰性值机制：只计算实际需要的输入，提升性能
- ✅ 常规分支控制：基于布尔值的条件分支
- ✅ 文本匹配分支：基于文本索引匹配命名输入
- ✅ 数字切换分支：基于数字切换(1-5)直接匹配输入

## 安装方法

1. 将整个插件文件夹复制到 ComfyUI 的 `custom_nodes` 目录：
   ```
   ComfyUI/custom_nodes/comfy_anydoor/
   ```

2. 重启 ComfyUI

## 节点说明

所有节点都在 `🔵BB anydoor` 分类下。

---

### 1. 🔵BB控制节点Bypass (NodeBypassController)

根据节点编号控制工作流中任意节点的 bypass 状态。

**输入参数：**
- `node_id` (STRING, 必需): 要控制的节点编号（节点ID）
  - 支持单个节点：`25`
  - 支持多个节点：`25,30,35` 或 `25 30 35`
- `set_bypass` (选择框, 必需): 节点模式
  - **正常执行(0)**: 节点正常执行计算
  - **禁用(1)**: 节点显示为灰色，不执行计算，输出中断下游
  - **忽略(2)**: 节点被跳过，输入直接传递到输出，保持连接完整性
- `trigger` (INT, 可选): 触发控制的标志（0或1）

**输出：**
- `status_info` (STRING): 控制操作的详细状态信息
- `mode_value` (INT): 设置的模式值（0, 1, 或 2）

**使用示例：**
```
node_id = "25,30,35"
set_bypass = "忽略"
→ 将节点25、30、35设置为忽略状态
```

---

### 2. 🔵BB文本匹配节点控制器 (TextMatchNodeController)

根据文本索引匹配，控制对应节点为忽略状态。

**输入参数：**
- `index_text` (STRING, 必需): 索引输入的文本，用于匹配
- `text1` - `text5` (STRING, 可选): 5组匹配文本
- `node_id1` - `node_id5` (STRING, 可选): 5组对应的节点ID

**工作原理：**
- 如果索引文本匹配某一组的文本，该组对应的节点将被设置为"忽略"状态
- 未匹配组的节点将恢复为正常状态

**输出：**
- `status_info` (STRING): 匹配和控制操作的详细状态信息
- `mode_value` (INT): 模式值（0=正常，2=忽略）

**使用示例：**
```
index_text = "小猫"
text1 = "小猫", node_id1 = "25,30"
text2 = "小狗", node_id2 = "35,40"

→ 匹配到text1，节点25和30被设置为忽略，节点35和40恢复为正常
```

---

### 3. 🔵BB切换节点控制 (FiveButtonBypassController)

五键切换节点控制器：提供5组节点ID，选择当前激活的索引（0-5）。

**输入参数：**
- `active_index` (INT, 必需): 当前按钮索引（0-5）
  - `0`: 所有节点正常执行
  - `1-5`: 对应组忽略，其余组正常
- `node_id1` - `node_id5` (STRING, 必需): 5组对应的节点ID

**输出：**
- `status_info` (STRING): 切换操作的详细状态信息
- `mode_value` (INT): 模式值

**使用示例：**
```
active_index = 2
node_id1 = "25,30"
node_id2 = "35,40"
node_id3 = "45,50"

→ 节点35和40被设置为忽略，节点25、30、45、50恢复为正常
```

---

### 4. 🔵BB andider常规分支控制 (LazyDiversioner)

基于惰性值机制的条件分支节点，根据布尔值选择输出路径。

**输入参数：**
- `divert` (BOOLEAN, 必需): 条件判断值
  - `True`: 输出 `TRUE_IN`
  - `False`: 输出 `FALSE_IN`
- `TRUE_IN` (任意类型, 可选, 惰性): 当 `divert` 为 `True` 时输出的值
- `FALSE_IN` (任意类型, 可选, 惰性): 当 `divert` 为 `False` 时输出的值

**输出：**
- `*` (任意类型): 根据 `divert` 值返回对应的输入

**惰性值机制：**
- 只有被选中的输入才会被计算，未选中的输入会被跳过
- 当 `divert=True` 时，只计算 `TRUE_IN`，跳过 `FALSE_IN`
- 当 `divert=False` 时，只计算 `FALSE_IN`，跳过 `TRUE_IN`

**使用示例：**
```
divert = True
TRUE_IN = [计算节点A]  → 只计算节点A
FALSE_IN = [计算节点B] → 跳过节点B
```

---

### 5. 🔵BB andider文本匹配分支控制器 (LazyTextIndexer)

基于文本索引匹配输入名称的惰性值机制节点。

**输入参数：**
- `index` (STRING, 必需): 文本索引，用于匹配输入名称
- `input1_name` - `input5_name` (STRING, 可选): 5个输入的名称
- `input1` - `input5` (任意类型, 可选, 惰性): 5个输入的计算值

**输出：**
- `*` (任意类型): 根据索引匹配的输入值，如果没有匹配则返回 `None`

**惰性值机制：**
- 根据索引匹配输入名称，只计算匹配的输入
- 未匹配的输入会被跳过，节省计算资源

**使用示例：**
```
index = "小猫"
input1_name = "小猫", input1 = [计算节点A]  → 匹配，只计算节点A
input2_name = "小狗", input2 = [计算节点B]  → 不匹配，跳过节点B
input3_name = "小鸟", input3 = [计算节点C]  → 不匹配，跳过节点C

结果：只执行节点A的计算，节点B和C被跳过
```

---

### 6. 🔵BB andider切换分支控制 (LazySwitch)

基于数字切换(1-5)直接匹配输入的惰性值机制节点。

**输入参数：**
- `switch` (INT, 必需): 切换值，范围1-5，对应input1-input5
- `input1` - `input5` (任意类型, 可选, 惰性): 5个输入的计算值

**输出：**
- `*` (任意类型): 根据切换值匹配的输入值，如果切换值超出范围则返回 `None`

**惰性值机制：**
- 根据切换值(1-5)直接匹配对应的输入
- 只有匹配的输入会被计算，其他输入会被跳过

**使用示例：**
```
switch = 1
input1 = [计算节点A]  → 匹配，只计算节点A
input2 = [计算节点B]  → 不匹配，跳过节点B
input3 = [计算节点C]  → 不匹配，跳过节点C
input4 = [计算节点D]  → 不匹配，跳过节点D
input5 = [计算节点E]  → 不匹配，跳过节点E

结果：只执行节点A的计算，节点B、C、D、E被跳过
```

---

## 节点模式说明

ComfyUI 节点有以下几种模式：

- **0 - 正常执行**：节点正常执行，处理输入并产生输出
- **1 - 禁用**：节点被禁用，不会执行，不会产生输出
- **2 - 忽略**：节点被跳过，输入直接传递到输出，保持连接完整性

## 惰性值机制说明

惰性值机制是 ComfyUI 的一个高级特性，可以显著提升工作流执行效率：

1. **标记惰性输入**：输入参数中设置了 `"lazy": True`，标记为惰性输入
2. **动态计算决定**：`check_lazy_status` 方法根据条件决定哪些输入需要实际计算
3. **跳过不必要计算**：只有被选中的输入才会被计算，未选中的输入会被跳过，从而节省计算资源

**优势：**
- 减少不必要的计算，提升性能
- 节省 GPU/CPU 资源
- 加快工作流执行速度

## 使用场景

### 场景1：动态控制节点执行
```
工作流中有多个处理节点，根据条件动态决定哪些节点执行：
- 节点5：图像预处理
- 节点8：图像增强
- 使用 AnyDoor 节点根据输入条件动态设置节点5和节点8的模式
```

### 场景2：快速测试工作流
```
临时禁用某些节点来测试工作流的其他部分：
- 添加控制节点，输入要禁用的节点编号
- 选择"禁用"模式
- 节点立即被禁用，可以快速测试
```

### 场景3：条件分支处理
```
根据条件决定是否执行某些处理步骤：
- 使用 LazyDiversioner 根据布尔值选择分支
- 使用 LazyTextIndexer 根据文本匹配选择分支
- 使用 LazySwitch 根据数字切换选择分支
```

### 场景4：性能优化
```
使用惰性值机制节点避免不必要的计算：
- 在复杂工作流中，只计算实际需要的分支
- 大幅减少计算时间和资源消耗
```

## 故障排除

### 节点状态没有改变

1. **检查节点编号**：
   - 确保输入的节点编号正确
   - 在 ComfyUI 界面中，可以查看每个节点的 ID（通常在节点信息中显示）

### 找不到节点

- 确保节点编号与工作流中实际节点的 ID 匹配
- 节点 ID 是数字，不是节点标题或类型名称
- 可以在 ComfyUI 中右键节点查看节点信息来确认节点 ID

### 惰性值节点不工作

- 确保输入参数中设置了 `"lazy": True`
- 确保节点类中实现了 `check_lazy_status` 方法
- 检查 ComfyUI 版本是否支持惰性值机制

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License
